<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.tongzhu.user.mapper.ext.UserExtMapper" >
    <resultMap id="BaseResultMap" type="com.tongzhu.user.model.User" >
        <id column="id" property="id" jdbcType="VARCHAR" />
        <result column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="name" property="name" jdbcType="VARCHAR" />
        <result column="portrait_url" property="portraitUrl" jdbcType="VARCHAR" />
        <result column="grade" property="grade" jdbcType="INTEGER" />
        <result column="selling_price" property="sellingPrice" jdbcType="INTEGER" />
        <result column="autograph" property="autograph" jdbcType="VARCHAR" />
        <result column="lottery" property="lottery" jdbcType="INTEGER" />
        <result column="vip" property="vip" jdbcType="INTEGER" />
        <result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
        <result column="update_date" property="updateDate" jdbcType="TIMESTAMP" />
        <result column="role_id" property="roleId" jdbcType="INTEGER" />
        <result column="status_" property="status" jdbcType="INTEGER" />
        <result column="login_date" property="loginDate" jdbcType="TIMESTAMP" />
        <result column="open_id" property="openId" jdbcType="VARCHAR" />
        <result column="sex" property="sex" jdbcType="INTEGER" />
        <result column="province" property="province" jdbcType="VARCHAR" />
        <result column="city" property="city" jdbcType="VARCHAR" />
        <result column="country" property="country" jdbcType="VARCHAR" />
        <result column="union_id" property="unionId" jdbcType="VARCHAR" />
    </resultMap>

    <resultMap id="RankingResultMap" type="com.tongzhu.user.mapper.vo.UserRankingVO" >
        <id column="id" property="id" jdbcType="VARCHAR" />
        <result column="user_id" property="userId" jdbcType="VARCHAR" />
        <result column="name" property="name" jdbcType="VARCHAR" />
        <result column="portrait_url" property="portraitUrl" jdbcType="VARCHAR" />
        <result column="grade" property="grade" jdbcType="INTEGER" />
        <result column="selling_price" property="sellingPrice" jdbcType="INTEGER" />
        <result column="autograph" property="autograph" jdbcType="VARCHAR" />
        <result column="lottery" property="lottery" jdbcType="INTEGER" />
        <result column="vip" property="vip" jdbcType="INTEGER" />
        <result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
        <result column="update_date" property="updateDate" jdbcType="TIMESTAMP" />
        <result column="role_id" property="roleId" jdbcType="INTEGER" />
        <result column="status_" property="status" jdbcType="INTEGER" />
        <result column="login_date" property="loginDate" jdbcType="TIMESTAMP" />
        <result column="open_id" property="openId" jdbcType="VARCHAR" />
        <result column="sex" property="sex" jdbcType="INTEGER" />
        <result column="province" property="province" jdbcType="VARCHAR" />
        <result column="city" property="city" jdbcType="VARCHAR" />
        <result column="country" property="country" jdbcType="VARCHAR" />
        <result column="union_id" property="unionId" jdbcType="VARCHAR" />
        <result column="serial_no" property="serialNo" jdbcType="INTEGER"/>
        <result column="amount" property="amount" jdbcType="INTEGER"/>
    </resultMap>

    <select id="selectUserForBuyByRand" resultMap="BaseResultMap" parameterType="map" >
        SELECT id, users.user_id, `name`, portrait_url, grade, selling_price, autograph, lottery, vip, create_date, update_date, role_id, status_, login_date
        FROM tz_user users
        LEFT JOIN (
        SELECT worker_id AS user_id FROM tz_tree_house_room WHERE worker_id IS NOT NULL AND (protect_end_date IS NOT NULL AND protect_end_date &gt;#{protectEndDate,jdbcType=TIMESTAMP})
        UNION
        SELECT user_id FROM tz_user_exchange_record WHERE exchange_date=#{exchangeDate,jdbcType=TIMESTAMP} AND exchange_count &gt;=#{exchangeCount,jdbcType=INTEGER}
        UNION
        SELECT friends_id AS user_id FROM tz_user_friends WHERE user_id=#{userId,jdbcType=VARCHAR}
        UNION
        SELECT user_id FROM tz_user_friends WHERE friends_id=#{userId,jdbcType=VARCHAR}
        UNION
        SELECT #{userId,jdbcType=VARCHAR} AS user_id
        ) uu ON users.`user_id`=uu.user_id
        WHERE uu.user_id IS NULL AND (users.selling_price BETWEEN #{minSellingPrice,jdbcType=INTEGER} AND #{maxSellingPrice,jdbcType=INTEGER})
        ORDER BY RAND() LIMIT #{count,jdbcType=INTEGER}
    </select>

    <select id="selectFriendsForBuyByRand" resultMap="BaseResultMap" parameterType="map">
        SELECT us.* FROM (
            SELECT friends_id AS user_id FROM tz_user_friends uf  LEFT JOIN (
                SELECT worker_id AS user_id FROM tz_tree_house_room WHERE worker_id IS NOT NULL AND (protect_end_date &lt;#{protectEndDate,jdbcType=TIMESTAMP})
                UNION
                SELECT user_id FROM tz_user_exchange_record WHERE exchange_date=#{exchangeDate,jdbcType=TIMESTAMP} AND exchange_count &gt;=#{exchangeCount,jdbcType=INTEGER}
            )um ON uf.`friends_id`=um.user_id WHERE uf.user_id=#{userId,jdbcType=VARCHAR} AND uf.status_=#{status,jdbcType=INTEGER} AND um.user_id IS NULL
            UNION
            SELECT uf.user_id FROM tz_user_friends uf  LEFT JOIN (
                SELECT worker_id AS user_id FROM tz_tree_house_room WHERE worker_id IS NOT NULL AND (protect_end_date &lt;#{protectEndDate,jdbcType=TIMESTAMP})
                UNION
                SELECT user_id FROM tz_user_exchange_record WHERE exchange_date=#{exchangeDate,jdbcType=TIMESTAMP} AND exchange_count &gt;=#{exchangeCount,jdbcType=INTEGER}
            ) um ON uf.user_id=um.user_id WHERE uf.friends_id=#{userId,jdbcType=VARCHAR} AND uf.status_=#{status,jdbcType=INTEGER} AND um.user_id IS NULL
        ) uu
        LEFT JOIN tz_user us ON uu.user_id=us.user_id WHERE us.selling_price &lt;=#{sellingPrice,jdbcType=INTEGER}
        ORDER BY RAND() LIMIT #{count,jdbcType=INTEGER};
    </select>

    <select id="selectForSellingPriceRanklingList" resultMap="RankingResultMap" parameterType="map">
        SELECT (@i:=@i+1) AS serial_no,u.* FROM tz_user u,(SELECT @i:=0) tt ORDER BY u.selling_price DESC LIMIT #{count,jdbcType=INTEGER}
    </select>

    <select id="selectForMoneyRanklingList" resultMap="RankingResultMap" parameterType="map">
        SELECT (@i:=@i+1) AS serial_no,us.* FROM (
          SELECT u.*,g.amount FROM tz_user u LEFT JOIN tz_user_goods g ON u.user_id=g.user_id AND g.goods_id=#{goodsId,jdbcType=INTEGER} ORDER BY g.amount DESC LIMIT #{count,jdbcType=INTEGER}
        ) us,(SELECT   @i:=0) t2
    </select>

</mapper>